openapi: 3.0.3
info:
  title: Process Flow API
  description: |
    API for managing process flow data including lanes, nodes, relationships, and texts.
    This API provides full CRUD operations for all entities in the process flow system.
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: https://api.example.com/v1
    description: Production server
  - url: https://staging-api.example.com/v1
    description: Staging server
  - url: http://localhost:3000/v1
    description: Local development server

tags:
  - name: Lanes
    description: Operations related to process lanes
  - name: Nodes
    description: Operations related to process nodes
  - name: Node Children
    description: Operations for managing node relationships
  - name: Node Texts
    description: Operations for managing node text descriptions
  - name: Bulk Operations
    description: Bulk import and export operations

paths:
  # ==========================================
  # LANES ENDPOINTS
  # ==========================================
  /lanes:
    get:
      tags:
        - Lanes
      summary: Get all lanes
      description: Retrieves a list of all lanes ordered by position
      parameters:
        - name: sort
          in: query
          schema:
            type: string
            enum: [position, label, id]
            default: position
          description: Field to sort by
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Lane'
                  count:
                    type: integer
                    example: 6
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Lanes
      summary: Create a new lane
      description: Creates a new process lane
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LaneInput'
      responses:
        '201':
          description: Lane created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Lane'
                  message:
                    type: string
                    example: Lane created successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /lanes/{id}:
    get:
      tags:
        - Lanes
      summary: Get lane by ID
      description: Retrieves a specific lane by its ID
      parameters:
        - $ref: '#/components/parameters/LaneId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Lane'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Lanes
      summary: Update lane
      description: Updates an existing lane
      parameters:
        - $ref: '#/components/parameters/LaneId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LaneInput'
      responses:
        '200':
          description: Lane updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Lane'
                  message:
                    type: string
                    example: Lane updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Lanes
      summary: Delete lane
      description: Deletes a lane and all associated nodes (cascade)
      parameters:
        - $ref: '#/components/parameters/LaneId'
      responses:
        '200':
          description: Lane deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Lane deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==========================================
  # NODES ENDPOINTS
  # ==========================================
  /nodes:
    get:
      tags:
        - Nodes
      summary: Get all nodes
      description: Retrieves all nodes with optional filtering
      parameters:
        - name: lane_id
          in: query
          schema:
            type: string
          description: Filter by lane ID
        - name: state
          in: query
          schema:
            type: string
            enum: [Positive, Negative, Critical, Neutral, Planned]
          description: Filter by state
        - name: focused
          in: query
          schema:
            type: boolean
          description: Filter by focused status
        - name: include_texts
          in: query
          schema:
            type: boolean
            default: false
          description: Include node texts in response
        - name: include_children
          in: query
          schema:
            type: boolean
            default: false
          description: Include children relationships
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Node'
                  count:
                    type: integer
                    example: 14
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Nodes
      summary: Create a new node
      description: Creates a new process node
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeInput'
      responses:
        '201':
          description: Node created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Node'
                  message:
                    type: string
                    example: Node created successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /nodes/{id}:
    get:
      tags:
        - Nodes
      summary: Get node by ID
      description: Retrieves a specific node with optional related data
      parameters:
        - $ref: '#/components/parameters/NodeId'
        - name: include_texts
          in: query
          schema:
            type: boolean
            default: true
          description: Include node texts
        - name: include_children
          in: query
          schema:
            type: boolean
            default: true
          description: Include children relationships
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/NodeComplete'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Nodes
      summary: Update node
      description: Updates an existing node
      parameters:
        - $ref: '#/components/parameters/NodeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeInput'
      responses:
        '200':
          description: Node updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Node'
                  message:
                    type: string
                    example: Node updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags:
        - Nodes
      summary: Partially update node
      description: Updates specific fields of a node
      parameters:
        - $ref: '#/components/parameters/NodeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                state:
                  type: string
                  enum: [Positive, Negative, Critical, Neutral, Planned]
                state_text:
                  type: string
                focused:
                  type: boolean
              example:
                state: Critical
                state_text: At risk
      responses:
        '200':
          description: Node updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Node'
                  message:
                    type: string
                    example: Node updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Nodes
      summary: Delete node
      description: Deletes a node and all associated data
      parameters:
        - $ref: '#/components/parameters/NodeId'
      responses:
        '200':
          description: Node deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Node deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==========================================
  # NODE CHILDREN ENDPOINTS
  # ==========================================
  /nodes/{id}/children:
    get:
      tags:
        - Node Children
      summary: Get node children
      description: Retrieves all children of a specific node
      parameters:
        - $ref: '#/components/parameters/NodeId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/NodeChild'
                  count:
                    type: integer
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Node Children
      summary: Add child to node
      description: Creates a parent-child relationship between nodes
      parameters:
        - $ref: '#/components/parameters/NodeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - child_id
              properties:
                child_id:
                  type: string
                  example: "20"
                sequence_order:
                  type: integer
                  example: 1
      responses:
        '201':
          description: Child relationship created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/NodeChild'
                  message:
                    type: string
                    example: Child relationship created successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /nodes/{id}/children/{child_id}:
    delete:
      tags:
        - Node Children
      summary: Remove child from node
      description: Removes a parent-child relationship
      parameters:
        - $ref: '#/components/parameters/NodeId'
        - name: child_id
          in: path
          required: true
          schema:
            type: string
          description: Child node ID
      responses:
        '200':
          description: Child relationship removed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Child relationship removed successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==========================================
  # NODE TEXTS ENDPOINTS
  # ==========================================
  /nodes/{id}/texts:
    get:
      tags:
        - Node Texts
      summary: Get node texts
      description: Retrieves all text descriptions for a node
      parameters:
        - $ref: '#/components/parameters/NodeId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/NodeText'
                  count:
                    type: integer
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Node Texts
      summary: Add text to node
      description: Adds a new text description to a node
      parameters:
        - $ref: '#/components/parameters/NodeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - text_content
              properties:
                text_content:
                  type: string
                  maxLength: 500
                  example: "Vaporizer"
                sequence_order:
                  type: integer
                  example: 1
      responses:
        '201':
          description: Text added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/NodeText'
                  message:
                    type: string
                    example: Text added successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Node Texts
      summary: Replace all node texts
      description: Replaces all existing texts for a node with new ones
      parameters:
        - $ref: '#/components/parameters/NodeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - texts
              properties:
                texts:
                  type: array
                  items:
                    type: string
                  example: ["Vaporizer", "Compressor"]
      responses:
        '200':
          description: Texts replaced successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/NodeText'
                  message:
                    type: string
                    example: Texts replaced successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /nodes/{id}/texts/{text_id}:
    put:
      tags:
        - Node Texts
      summary: Update text
      description: Updates a specific text entry
      parameters:
        - $ref: '#/components/parameters/NodeId'
        - name: text_id
          in: path
          required: true
          schema:
            type: integer
          description: Text ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - text_content
              properties:
                text_content:
                  type: string
                  maxLength: 500
                sequence_order:
                  type: integer
      responses:
        '200':
          description: Text updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/NodeText'
                  message:
                    type: string
                    example: Text updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Node Texts
      summary: Delete text
      description: Deletes a specific text entry
      parameters:
        - $ref: '#/components/parameters/NodeId'
        - name: text_id
          in: path
          required: true
          schema:
            type: integer
          description: Text ID
      responses:
        '200':
          description: Text deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Text deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==========================================
  # BULK OPERATIONS
  # ==========================================
  /bulk/import:
    post:
      tags:
        - Bulk Operations
      summary: Bulk import process flow
      description: |
        Imports a complete process flow from JSON format.
        This endpoint accepts the same JSON structure as your original file
        and populates all tables accordingly.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessFlowImport'
      responses:
        '201':
          description: Import successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Process flow imported successfully
                  summary:
                    type: object
                    properties:
                      lanes_created:
                        type: integer
                        example: 6
                      nodes_created:
                        type: integer
                        example: 14
                      relationships_created:
                        type: integer
                        example: 15
                      texts_created:
                        type: integer
                        example: 14
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /bulk/export:
    get:
      tags:
        - Bulk Operations
      summary: Bulk export process flow
      description: Exports the complete process flow in JSON format
      responses:
        '200':
          description: Export successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessFlowExport'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /nodes/{id}/complete:
    get:
      tags:
        - Nodes
      summary: Get complete node data
      description: Retrieves a node with all related data (lane, texts, children)
      parameters:
        - $ref: '#/components/parameters/NodeId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/NodeComplete'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /health:
    get:
      tags:
        - Bulk Operations
      summary: Health check
      description: Check API health status
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time
                  database:
                    type: string
                    example: connected

# ==========================================
# COMPONENTS
# ==========================================
components:
  parameters:
    LaneId:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: Lane ID
      example: "1"

    NodeId:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: Node ID
      example: "10"

  schemas:
    # Lane Schemas
    Lane:
      type: object
      properties:
        id:
          type: string
          example: "0"
        icon:
          type: string
          example: "sap-icon://cart-3"
        label:
          type: string
          example: "Order"
        position:
          type: integer
          example: 0
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LaneInput:
      type: object
      required:
        - id
        - icon
        - label
        - position
      properties:
        id:
          type: string
          maxLength: 10
          example: "0"
        icon:
          type: string
          maxLength: 100
          example: "sap-icon://cart-3"
        label:
          type: string
          maxLength: 100
          example: "Order"
        position:
          type: integer
          minimum: 0
          example: 0

    # Node Schemas
    Node:
      type: object
      properties:
        id:
          type: string
          example: "10"
        lane_id:
          type: string
          example: "1"
        title:
          type: string
          example: "Manufacturing: Freezer"
        title_abbreviation:
          type: string
          example: "MAF"
        state:
          type: string
          enum: [Positive, Negative, Critical, Neutral, Planned]
          example: "Positive"
        state_text:
          type: string
          nullable: true
          example: "Finished"
        focused:
          type: boolean
          example: false
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    NodeInput:
      type: object
      required:
        - id
        - lane_id
        - title
        - title_abbreviation
        - state
      properties:
        id:
          type: string
          maxLength: 10
          example: "10"
        lane_id:
          type: string
          maxLength: 10
          example: "1"
        title:
          type: string
          maxLength: 255
          example: "Manufacturing: Freezer"
        title_abbreviation:
          type: string
          maxLength: 20
          example: "MAF"
        state:
          type: string
          enum: [Positive, Negative, Critical, Neutral, Planned]
          example: "Positive"
        state_text:
          type: string
          maxLength: 100
          nullable: true
          example: "Finished"
        focused:
          type: boolean
          default: false
          example: false

    NodeComplete:
      allOf:
        - $ref: '#/components/schemas/Node'
        - type: object
          properties:
            lane:
              $ref: '#/components/schemas/Lane'
            texts:
              type: array
              items:
                $ref: '#/components/schemas/NodeText'
            children:
              type: array
              items:
                type: string
              example: ["20"]

    # Node Child Schemas
    NodeChild:
      type: object
      properties:
        parent_id:
          type: string
          example: "10"
        child_id:
          type: string
          example: "20"
        sequence_order:
          type: integer
          example: 1
        created_at:
          type: string
          format: date-time

    # Node Text Schemas
    NodeText:
      type: object
      properties:
        id:
          type: integer
          example: 1
        node_id:
          type: string
          example: "10"
        text_content:
          type: string
          example: "Vaporizer"
        sequence_order:
          type: integer
          example: 1
        created_at:
          type: string
          format: date-time

    # Bulk Import/Export Schemas
    ProcessFlowImport:
      type: object
      required:
        - Nodes
        - Lanes
      properties:
        Nodes:
          type: array
          items:
            type: object
            required:
              - id
              - lane
              - title
              - titleAbbreviation
              - state
            properties:
              id:
                type: string
              lane:
                type: string
              title:
                type: string
              titleAbbreviation:
                type: string
              children:
                type: array
                items:
                  type: integer
                nullable: true
              state:
                type: string
                enum: [Positive, Negative, Critical, Neutral, Planned]
              stateText:
                type: string
                nullable: true
              focused:
                type: boolean
              texts:
                type: array
                items:
                  type: string
        Lanes:
          type: array
          items:
            type: object
            required:
              - id
              - icon
              - label
              - position
            properties:
              id:
                type: string
              icon:
                type: string
              label:
                type: string
              position:
                type: integer

    ProcessFlowExport:
      type: object
      properties:
        Nodes:
          type: array
          items:
            type: object
        Lanes:
          type: array
          items:
            type: object

    # Error Schemas
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "VALIDATION_ERROR"
            message:
              type: string
              example: "Invalid input data"
            details:
              type: array
              items:
                type: string
        timestamp:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: "VALIDATION_ERROR"
              message: "Invalid input data"
              details:
                - "title is required"
                - "state must be one of: Positive, Negative, Critical, Neutral, Planned"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: "NOT_FOUND"
              message: "Resource not found"
              details: []

    Conflict:
      description: Conflict - resource already exists
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: "CONFLICT"
              message: "Resource already exists"
              details:
                - "A lane with this ID already exists"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              code: "INTERNAL_ERROR"
              message: "An unexpected error occurred"
              details: []

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication

    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication

security:
  - BearerAuth: []
  - ApiKeyAuth: []
